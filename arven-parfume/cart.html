<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Keranjang - ARVEN PARFUME</title>
  <link rel="stylesheet" href="stylecart.css">
</head>
<body>
  <header>
    <div class="logo"><a href="index.html">ARVEN PARFUME</a></div>

    <div class="header-right-nav">
      <nav>
        <ul>
          <li><a href="index.html">BERANDA</a></li>
          <li><a href="about.html">TENTANG KAMI</a></li>
          <li><a href="koleksi.html">KOLEKSI</a></li>
          <li><a href="contact.html">KONTAK</a></li>
          <li><a href="cart.html" class="cart-icon" title="Keranjang">ðŸ›’
              <span id="cartBadge" class="cart-badge" style="display:none">0</span></a>
          </li>
        </ul>
      </nav>

      <!-- Nama user di paling kanan -->
      <div class="header-icons">
        <div id="userMenu" class="user-name">Login</div>
      </div>
    </div>
  </header>

  <main class="container">
    <h1>Keranjang Belanja</h1>
    <div class="muted">Periksa item di keranjangmu. Kamu bisa ubah jumlah atau hapus item.</div>

    <div class="cart-wrap">
      <!-- LIST ITEM -->
      <section class="cart-list" id="cartList">
        <!-- Jika kosong, tampilkan .empty -->
      </section>

      <!-- SUMMARY -->
      <aside class="cart-summary" id="cartSummary">
        <div class="small-muted">Ringkasan Pesanan</div>
        <div class="hr"></div>

        <div class="summary-row">
          <div>Subtotal</div>
          <div id="subtotalText">Rp 0</div>
        </div>

        <div class="summary-row">
          <div>Biaya pengiriman</div>
          <div id="shippingText">Rp 0</div>
        </div>

        <div class="hr"></div>

        <div class="summary-row summary-total">
          <div>Total</div>
          <div id="totalText">Rp 0</div>
        </div>

        <div style="margin-top:14px;display:flex;gap:10px;flex-direction:column">
          <button id="checkoutBtn" class="btn btn-primary">Checkout</button>
          <button id="clearBtn" class="btn btn-ghost">Kosongkan Keranjang</button>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ---------- UTIL ----------
    const STORAGE_KEY = 'arven_cart_v1';
    const currency = (n) => {
      // format sederhana ke Rupiah: 1.234.567
      return 'Rp ' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    };

    // ---------- CART HELPERS ----------
    function readCart() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        console.error('Gagal membaca cart:', e);
        return [];
      }
    }

    function writeCart(cart) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
      renderCart();
      updateBadge();
    }

    function getCartCount() {
      return readCart().reduce((s, it) => s + (it.qty || 0), 0);
    }

    function updateBadge() {
      const badge = document.getElementById('cartBadge');
      const count = getCartCount();
      if (!badge) return;
      if (count > 0) {
        badge.style.display = 'inline-flex';
        badge.textContent = count;
      } else {
        badge.style.display = 'none';
      }
    }

    // ---------- CART ACTIONS ----------
    function addToCart(item) {
      // item = { id, name, price, qty = 1, image }
      const cart = readCart();
      const idx = cart.findIndex(i => i.id == item.id);
      if (idx >= 0) {
        cart[idx].qty = (cart[idx].qty || 1) + (item.qty || 1);
      } else {
        cart.push({
          id: item.id,
          name: item.name,
          price: Number(item.price) || 0,
          qty: Number(item.qty) || 1,
          image: item.image || ''
        });
      }
      writeCart(cart);
    }

    function setQty(id, qty) {
      const cart = readCart();
      const idx = cart.findIndex(i => i.id == id);
      if (idx >= 0) {
        cart[idx].qty = Math.max(0, Number(qty) || 0);
        if (cart[idx].qty === 0) cart.splice(idx, 1);
        writeCart(cart);
      }
    }

    function changeQty(id, delta) {
      const cart = readCart();
      const idx = cart.findIndex(i => i.id == id);
      if (idx >= 0) {
        cart[idx].qty = Math.max(1, (cart[idx].qty || 1) + delta);
        writeCart(cart);
      }
    }

    function removeItem(id) {
      let cart = readCart();
      cart = cart.filter(i => i.id != id);
      writeCart(cart);
    }

    function clearCart() {
      localStorage.removeItem(STORAGE_KEY);
      renderCart();
      updateBadge();
    }

    // ---------- RENDER ----------
    function renderCart() {
      const container = document.getElementById('cartList');
      const summary = document.getElementById('cartSummary');
      const cart = readCart();

      if (!container) return;

      if (!cart.length) {
        container.innerHTML = `
          <div class="empty">
            <div style="font-size:20px;font-weight:600;margin-bottom:8px">Keranjang kosong</div>
            <div class="small-muted">Belum ada item di keranjang. Kunjungi <a href="koleksi.html">koleksi</a> untuk menambahkan produk.</div>
          </div>`;
        // reset summary
        document.getElementById('subtotalText').textContent = currency(0);
        document.getElementById('shippingText').textContent = currency(0);
        document.getElementById('totalText').textContent = currency(0);
        return;
      }

      // render list
      container.innerHTML = cart.map(it => {
        const subtotal = (it.price * it.qty) || 0;
        return `
          <div class="cart-item" data-id="${it.id}">
            <div class="item-thumb">
              ${it.image ? `<img src="${it.image}" alt="${escapeHtml(it.name)}">` : `<span style="font-size:12px;color:#999">No image</span>`}
            </div>

            <div class="item-info">
              <div class="item-title">${escapeHtml(it.name)}</div>
              <div class="item-price">${currency(it.price)} Â· <span class="small-muted">Subtotal: ${currency(subtotal)}</span></div>

              <div class="qty-controls">
                <button onclick="changeQty('${it.id}', -1)">âˆ’</button>
                <input type="number" min="1" value="${it.qty}" onchange="setQty('${it.id}', this.value)">
                <button onclick="changeQty('${it.id}', 1)">+</button>
              </div>
            </div>

            <div class="item-actions">
              <div style="font-weight:700">${currency(subtotal)}</div>
              <button class="remove-btn" onclick="removeItem('${it.id}')">Hapus</button>
            </div>
          </div>
        `;
      }).join('');

      // Summary calculation
      const subtotal = cart.reduce((s, it) => s + (it.price * it.qty), 0);
      const shipping = calculateShipping(subtotal);
      const total = subtotal + shipping;

      document.getElementById('subtotalText').textContent = currency(subtotal);
      document.getElementById('shippingText').textContent = currency(shipping);
      document.getElementById('totalText').textContent = currency(total);
    }

    // ---------- SHIPPING (sederhana) ----------
    function calculateShipping(subtotal) {
      // contoh: gratis ongkir di atas 500.000
      if (subtotal === 0) return 0;
      return subtotal >= 500000 ? 0 : 20000;
    }

    // ---------- SAFETY: escapeHtml ----------
    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ---------- INIT ----------
    document.addEventListener('DOMContentLoaded', function() {
      // set user name jika ada (sesuaikan dengan auth.js)
      const userMenu = document.getElementById('userMenu');
      try {
        const userJson = localStorage.getItem('arven_user'); // contoh jika auth.js menyimpan user
        if (userJson) {
          const user = JSON.parse(userJson);
          userMenu.textContent = user.name || user.email || 'Profil';
        } else {
          userMenu.innerHTML = '<a href="login.html" style="color:inherit">Login</a>';
        }
      } catch (e) { /* ignore */ }

      // tombol
      document.getElementById('clearBtn').addEventListener('click', function(){
        if (confirm('Kosongkan semua item di keranjang?')) clearCart();
      });

      document.getElementById('checkoutBtn').addEventListener('click', function(){
        const cart = readCart();
        if (!cart.length) {
          alert('Keranjang kosong!');
          return;
        }
        // Simulasi checkout: kirim ke server atau lanjut ke halaman checkout sebenarnya
        // contoh: redirect ke checkout.html
        // window.location.href = 'checkout.html';

        // untuk demo: tampilkan ringkasan dan kosongkan cart
        const subtotal = cart.reduce((s, it) => s + (it.price * it.qty), 0);
        const shipping = calculateShipping(subtotal);
        const total = subtotal + shipping;
        if (confirm(`Total pembayaran: ${currency(total)}. Lanjutkan checkout simulasi?`)) {
          // di sistem nyata: kirim lewat fetch ke backend
          alert('Checkout simulasi selesai. Keranjang akan dikosongkan.');
          clearCart();
        }
      });

      // render awal
      renderCart();
      updateBadge();
    });

    // expose addToCart ke global supaya bisa dipanggil dari halaman produk
    window.addToCart = addToCart;
    window.changeQty = changeQty;
    window.setQty = setQty;
    window.removeItem = removeItem;
  </script>
  
  <!-- JavaScript -->
<script src="cart.js"></script>
</body>
</html>
